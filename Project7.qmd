## 2.5 Variable Relationships

In this section, we perform chi-square tests to assess the association between categorical variables and obesity status, and then compute a correlation matrix (and its heatmap) on a numeric copy of the data.

### 2.5.1 Chi-square Tests

```{r}
# Define categorical variables
cat_vars <- c("AgeGroup", "Sex", "Employment", "Veg", "Fruit")
chi_results <- list()

# Perform chi-square tests comparing each categorical variable with Obese status
for (var in cat_vars) {
  chi_results[[var]] <- chisq.test(table(df[[var]], df$Obese))
}

# Extract and print p-values from the chi-square tests
chi_p_values <- sapply(chi_results, function(x) x$p.value)
print(chi_p_values)

```

Age group, employment status, and vegetable intake show significant associations with obesity, while sex and fruit intake do not reach statistical significance. These findings validate previous observations and highlight key influencing factors.

### 2.5.2 Correlation Analysis

For the correlation analysis, we create a numeric copy of the data to convert categorical variables into numerical codes.

```{r}

# Create a numeric copy (do NOT overwrite the original df)
df_num <- df

# Convert categorical variables to numeric
df_num$Obese      <- as.numeric(df_num$Obese == "Yes")  # 1 if Yes, 0 if No
df_num$Veg        <- as.numeric(df_num$Veg == "Yes")
df_num$Fruit      <- as.numeric(df_num$Fruit == "Yes")
df_num$Sex        <- as.numeric(df_num$Sex == "Female")   # 1 if Female, 0 if Male

# Convert factor variables to numeric codes
df_num$AgeGroup   <- as.numeric(as.factor(df_num$AgeGroup))
df_num$Employment <- as.numeric(as.factor(df_num$Employment))

# Subset columns for correlation analysis
df_cor <- df_num[, c("AgeGroup", "Sex", "Employment", "Veg", "Fruit", "Obese")]

# Remove columns with zero variance (only 1 unique value)
non_constant_cols <- sapply(df_cor, function(x) length(unique(x)) > 1)
df_cor <- df_cor[, non_constant_cols]

# Calculate the correlation matrix
cor_matrix <- cor(df_cor, use = "pairwise.complete.obs")
print(cor_matrix)

# Plot the correlation heatmap
# Improved correlation heatmap
corrplot(
  cor_matrix,
  method = "color",
  type = "upper",
  col = colorRampPalette(c("steelblue", "white", "firebrick"))(200),
  addCoef.col = "black",
  tl.col = "black",
  tl.srt = 45,
  tl.cex = 0.8,
  diag = FALSE,
  title = "Correlation Heatmap",
  mar = c(0, 0, 2, 0)
)

```

Age shows the strongest correlation with obesity (r = 0.10), followed by employment status (r = 0.06), while vegetable intake is negatively correlated (r = -0.03). Sex and fruit intake exhibit near-zero correlations, aligning with chi-square results, reinforcing their weaker influence.

### 2.5.3 Potential Influencing factors

```{r}
# Analyzing the significant factors from chi-square tests and correlation analysis

# Create a data frame of chi-square p-values for visualization
chi_results_df <- data.frame(
  Variable = names(chi_p_values),
  P_Value = chi_p_values,
  Significant = chi_p_values < 0.05
)

ggplot(chi_results_df, aes(x = reorder(Variable, P_Value), y = P_Value, fill = Significant)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 0.05, linetype = "dashed", color = "firebrick") +
  coord_flip() +
  scale_fill_manual(values = c("grey", "steelblue")) +
  theme_minimal() +
  labs(
    title = "Chi-square Test P-values for Association with Obesity",
    x = "Variable",
    y = "P-value",
    caption = "Red dashed line indicates significance level (0.05)"
  )

# Identify top correlations with obesity
obesity_correlations <- data.frame(
  Variable = colnames(cor_matrix),
  Correlation = cor_matrix[, "Obese"]
) %>%
  filter(Variable != "Obese") %>%
  arrange(desc(abs(Correlation)))

ggplot(obesity_correlations, aes(x = reorder(Variable, abs(Correlation)), 
                                y = Correlation, 
                                fill = Correlation > 0)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_manual(values = c("firebrick", "steelblue"), 
                    labels = c("Negative", "Positive")) +
  theme_minimal() +
  labs(
    title = "Correlations with Obesity Status",
    x = "Variable",
    y = "Correlation Coefficient",
    fill = "Direction"
  )

# Combine the insights from both analyses
cat("Based on the chi-square tests and correlation analysis, the following factors appear to have the strongest association with obesity status:\n")

# Print the significant factors from chi-square tests
sig_chi <- chi_results_df %>% filter(Significant == TRUE) %>% arrange(P_Value)
cat("Significant factors (chi-square):", paste(sig_chi$Variable, collapse = ", "), "\n")

# Print the top correlating factors
top_corr <- obesity_correlations %>% filter(abs(Correlation) > 0.05) %>% arrange(desc(abs(Correlation)))
cat("Top correlating factors:", paste(top_corr$Variable, collapse = ", "), "\n")

```

Age emerges as the most critical factor in obesity risk, followed by employment status and vegetable intake, while sex and fruit intake show weaker associations. The interaction between age and employment suggests socioeconomic factors play a key role in obesity prevalence.
